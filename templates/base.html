<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoyaleHub Esports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='tailwind-config.js') }}"></script>
</head>

<body class="bg-dark text-light font-rubik">
    <div x-data="cartOffCanvas" @keydown.escape="isOpen = false" class="fixed z-[60]">
        
        <!-- 1. Bot√£o Flutuante (FAB) -->
        <button @click="toggleCart(); $nextTick(() => { if(isOpen) fetchCartData() })"
            class="fixed bottom-6 right-6 lg:bottom-10 lg:right-10 
                p-4 rounded-full shadow-2xl transition duration-300 
                bg-primary hover:bg-primary/90 text-dark 
                transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-primary/50"
                aria-label="Abrir Carrinho">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                <circle cx="9" cy="21" r="1"></circle>
                <circle cx="20" cy="21" r="1"></circle>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
            <!-- Contador de itens no badge -->
            <span x-show="itemCount > 0" x-cloak x-text="itemCount" 
                class="absolute -top-1 -right-1 flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-red-600 border-2 border-dark rounded-full"></span>
        </button>

        <!-- 2. Overlay de Fundo (Para fechar ao clicar fora) -->
        <div x-show="isOpen" x-cloak
            x-transition:enter="ease-out duration-300"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="ease-in duration-200"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            @click="isOpen = false"
            class="fixed inset-0 bg-black/50 transition-opacity">
        </div>

        <!-- 3. Barra Lateral Off-Canvas -->
        <div x-show="isOpen" x-cloak
            x-transition:enter="transition ease-out duration-300 transform"
            x-transition:enter-start="translate-x-full"
            x-transition:enter-end="translate-x-0"
            x-transition:leave="transition ease-in duration-300 transform"
            x-transition:leave-start="translate-x-0"
            x-transition:leave-end="translate-x-full"
            @click.away="isOpen = false"
            class="fixed inset-y-0 right-0 w-full max-w-sm bg-dark shadow-2xl overflow-y-auto flex flex-col">

            <!-- Header -->
            <div class="p-6 border-b border-primary/20 sticky top-0 bg-dark z-10">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-orbitron font-bold text-light">
                        SEU CARRINHO (<span x-text="itemCount"></span>)
                    </h3>
                    <button @click="isOpen = false" class="text-light hover:text-primary transition p-2 rounded-full hover:bg-white/10" aria-label="Fechar Carrinho">
                        <i data-feather="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <!-- Conte√∫do do Carrinho (Scrollable) -->
            <div class="flex-grow p-6 space-y-4">
                <div x-show="isLoading" class="text-center text-primary/70 py-10">
                    <svg class="animate-spin h-6 w-6 text-primary mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2 text-sm">Carregando itens...</p>
                </div>
                
                <template x-if="!isLoading && cartItems.length === 0">
                    <div class="text-center py-10 text-light/70">
                        <p>Seu carrinho est√° vazio. Vamos √†s compras!</p>
                    </div>
                </template>
                
                <template x-for="item in cartItems" :key="item.id">
                    <div class="flex items-center space-x-4 p-3 bg-dark/50 rounded-lg border border-primary/10">
                        <!-- Imagem -->
                        <img :src="item.image_url" :alt="item.name" class="w-16 h-16 object-cover rounded-md border border-primary/30">
                        
                        <div class="flex-grow">
                            <p class="font-bold text-light" x-text="item.name"></p>
                            <p class="text-sm text-light/70">
                                Qtd: <span x-text="item.quantity"></span> &times; 
                                R$ <span x-text="item.price.toFixed(2)"></span>
                            </p>
                        </div>
                        
                        <span class="font-semibold text-primary">
                            R$ <span x-text="(item.price * item.quantity).toFixed(2)"></span>
                        </span>

                        <!-- Bot√£o de Remover (A√ß√£o de backend real necess√°ria) -->
                        <!-- Voc√™ precisaria criar uma rota Flask para remover o item/diminuir a quantidade -->
                        <button @click.prevent.stop="alert('Funcionalidade de remover item precisa de uma rota Flask!')" class="text-light/50 hover:text-red-500 transition" aria-label="Remover item">
                            <i data-feather="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </template>
            </div>

            <!-- Footer / Checkout -->
            <div class="p-6 border-t border-primary/20 sticky bottom-0 bg-dark z-10">
                <div class="flex justify-between items-center mb-4 text-light">
                    <span class="text-lg font-bold">Total:</span>
                    <span class="text-2xl font-orbitron font-bold text-primary">R$ <span x-text="cartTotal.toFixed(2)"></span></span>
                </div>
                <a href="/carrinho" class="block w-full text-center bg-primary hover:bg-primary/90 text-dark font-bold py-3 rounded-full transition duration-200">
                    IR PARA O CHECKOUT
                </a>
                <p class="text-center text-xs text-light/60 mt-2">Voc√™ ser√° redirecionado para a p√°gina de carrinho completa.</p>
            </div>
        </div>
    </div> 

    {% include 'header.html' %}

    <main class="pt-20">
        {% block content %}{% endblock %}
    </main>

    {% include 'footer.html' %}

    <!-- Ativar √≠cones -->
    <script>
        feather.replace();
    </script>

    <!-- Alpine JS (necess√°rio para o carrinho) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Menu mobile -->
    <script>
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });
    </script>

    <!-- Off-Canvas Carrinho -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('cartOffCanvas', () => ({
                isOpen: false,
                cartItems: [],
                isLoading: false,

                get cartTotal() {
                    return this.cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                },
                
                get itemCount() {
                    return this.cartItems.reduce((sum, item) => sum + item.quantity, 0);
                },
                
                // üöÄ NOVO: Adiciona a fun√ß√£o init() para monitorar o estado
                init() {
                    // Monitora a vari√°vel 'isOpen'
                    this.$watch('isOpen', (value) => {
                        // Usa classList para garantir que a classe seja adicionada/removida corretamente
                        document.body.classList.toggle('overflow-hidden', value);
                        
                        // Se preferir a manipula√ß√£o direta do style (menos recomendado, mas pode funcionar se classList n√£o resolver):
                        // document.body.style.overflow = value ? 'hidden' : '';
                    });
                },

                // üõ†Ô∏è toggleCart AGORA S√ì ALTERA O ESTADO
                toggleCart() {
                    this.isOpen = !this.isOpen;
                    // A manipula√ß√£o da barra de rolagem √© feita pelo $watch acima
                },

                async fetchCartData() {
                    if (this.isLoading) return;
                    this.isLoading = true;
                    
                    try {
                        // Chama a rota Flask que criamos no app.py
                        const response = await fetch('/api/cart');
                        if (!response.ok) {
                            throw new Error(`Erro HTTP: ${response.status}`);
                        }
                        const data = await response.json();
                        
                        this.cartItems = data.items;
                        
                    } catch (error) {
                        console.error('Erro ao buscar o carrinho:', error);
                    } finally {
                        this.isLoading = false;
                    }
                }
            }));
        });
        // Inicia os √≠cones feather-icons
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    </script>
</body>
</html>
