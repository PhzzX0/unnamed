{% extends 'base.html' %}
{% block content %}

<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<section class="py-24 px-6 max-w-7xl mx-auto" x-data="{ modalOpen: false, product: {} }">
    <h2 class="text-4xl font-orbitron font-bold mb-12 text-primary">LOJA OFICIAL</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
        {% for p in products %}
        
                {% set image_src = url_for('static', filename='uploads/products/' + p.image_file) if p.image_file else 'http://static.photos/black/640x360/1' %}

        <div class="bg-dark/50 border border-primary/20 rounded-xl overflow-hidden transform hover:scale-105 transition duration-300">
            <div class="relative h-64 overflow-hidden cursor-pointer" 
                @click="modalOpen = true; product = { 
                id: {{ p.id }}, 
                name: '{{ p.name }}', 
                price: {{ p.price }}, 
                description: '{{ p.description|default('Sem descrição') }}', 
                image_url: '{{ image_src }}'         }">
                        <img src="{{ image_src }}" alt="{{ p.name }}" class="w-full h-full object-cover">
                        
                <div class="absolute top-4 right-4">
                {% if p.tag %}
                <span class="bg-primary text-dark text-xs font-bold px-2 py-1 rounded-full">{{ p.tag }}</span>
                {% endif %}
                </div>
            </div>
            <div class="p-6">
                <h3 class="text-xl font-bold text-light mb-2">{{ p.name }}</h3>
                <div class="flex items-center mb-4">
                <div class="flex text-secondary">
                    {% for i in range(p.rating) %}
                    <i data-feather="star" class="w-4 h-4 fill-current"></i>
                    {% endfor %}
                </div>
                <span class="text-xs text-light/60 ml-2">({{ p.reviews }})</span>
                </div>
                <div class="flex justify-between items-center">
                <span class="text-primary font-bold text-lg">R$ {{ "%.2f"|format(p.price) }}</span>
                <button @click="modalOpen = true; product = { 
                    id: {{ p.id }}, 
                    name: '{{ p.name }}', 
                    price: {{ p.price }}, 
                    description: '{{ p.description|default('Sem descrição') }}', 
                    image_url: '{{ image_src }}'             }" 
                    class="bg-primary hover:bg-primary/90 text-dark font-bold py-2 px-4 rounded-full text-sm transition">
                    DETALHES
                </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div x-show="modalOpen" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black/70">
        <div @click.away="modalOpen = false" class="bg-dark rounded-xl max-w-lg w-full p-6 relative">
            <button @click="modalOpen = false" class="absolute top-4 right-4 text-light hover:text-primary">
                <i data-feather="x" class="w-6 h-6"></i>
            </button>
            <img :src="product.image_url" class="w-full h-64 object-cover rounded-lg mb-4">
            <h3 class="text-2xl font-bold text-light mb-2" x-text="product.name"></h3>
            <p class="text-light/80 mb-4" x-text="product.description"></p>
            <form method="POST" :action="'{{ url_for('add_to_cart', product_id=0) }}'.replace('0', product.id)">
                <div class="flex justify-between items-center mt-4">
                    <span class="text-primary font-bold text-xl" x-text="'R$ ' + product.price.toFixed(2)"></span>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> 
                    <button type="submit" 
                            class="bg-primary hover:bg-primary/90 text-dark font-bold py-2 px-4 rounded-full text-sm transition">
                        ADICIONAR AO CARRINHO
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>
{% endblock %}